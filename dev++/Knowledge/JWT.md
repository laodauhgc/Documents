# JWT To√†n T·∫≠p: H∆∞·ªõng d·∫´n Chi ti·∫øt t·ª´ A-Z cho L·∫≠p tr√¨nh vi√™n

Trong k·ª∑ nguy√™n c·ªßa c√°c ·ª©ng d·ª•ng web ph√¢n t√°n, microservices v√† single-page applications (SPA), vi·ªác x√°c th·ª±c v√† ·ªßy quy·ªÅn ng∆∞·ªùi d√πng m·ªôt c√°ch hi·ªáu qu·∫£ v√† an to√†n tr·ªü th√†nh m·ªôt th√°ch th·ª©c l·ªõn. C√°c ph∆∞∆°ng ph√°p truy·ªÅn th·ªëng d·ª±a tr√™n session l∆∞u tr·ªØ ph√≠a server ƒë√¥i khi b·ªôc l·ªô nh·ªØng h·∫°n ch·∫ø v·ªÅ kh·∫£ nƒÉng m·ªü r·ªông v√† qu·∫£n l√Ω tr·∫°ng th√°i. ƒê√¢y l√† l√∫c **JSON Web Token (JWT)** b∆∞·ªõc v√†o v√† cung c·∫•p m·ªôt gi·∫£i ph√°p m·∫°nh m·∫Ω, linh ho·∫°t.

B√†i vi·∫øt n√†y l√† c·∫©m nang to√†n di·ªán, ƒëi t·ª´ nh·ªØng kh√°i ni·ªám c∆° b·∫£n nh·∫•t ƒë·∫øn c√°c k·ªπ thu·∫≠t b·∫£o m·∫≠t n√¢ng cao, gi√∫p b·∫°n hi·ªÉu s√¢u v√† √°p d·ª•ng JWT m·ªôt c√°ch ch√≠nh x√°c v√† an to√†n trong c√°c d·ª± √°n c·ªßa m√¨nh. H√£y coi JWT nh∆∞ m·ªôt **"ch·ª©ng minh th∆∞ k·ªπ thu·∫≠t s·ªë" (digital ID card)**: n√≥ ch·ª©a th√¥ng tin v·ªÅ b·∫°n (claims), ƒë∆∞·ª£c c·∫•p b·ªüi m·ªôt c∆° quan uy t√≠n (server), v√† c√≥ th·ªÉ ƒë∆∞·ª£c x√°c minh d·ªÖ d√†ng nh·ªù con d·∫•u ch·ªëng gi·∫£ m·∫°o (ch·ªØ k√Ω s·ªë).

## Ph·∫ßn 1: Kh√°i ni·ªám C∆° b·∫£n v√† C·∫•u tr√∫c c·ªßa JWT

### 1. JWT l√† g√¨ v√† D√πng ƒë·ªÉ l√†m g√¨?

JWT (ph√°t √¢m l√† /d í…ít/) l√† m·ªôt **ti√™u chu·∫©n m·ªü (RFC 7519)**, ƒë·ªãnh nghƒ©a m·ªôt ph∆∞∆°ng th·ª©c **nh·ªè g·ªçn (compact)** v√† **kh√©p k√≠n (self-contained)** ƒë·ªÉ truy·ªÅn t·∫£i th√¥ng tin an to√†n gi·ªØa c√°c b√™n d∆∞·ªõi d·∫°ng m·ªôt ƒë·ªëi t∆∞·ª£ng JSON. "Kh√©p k√≠n" nghƒ©a l√† b·∫£n th√¢n token ƒë√£ ch·ª©a ƒë·ªß th√¥ng tin c·∫ßn thi·∫øt (v√≠ d·ª•: th√¥ng tin ng∆∞·ªùi d√πng) m√† kh√¥ng y√™u c·∫ßu server ph·∫£i tra c·ª©u th√™m ·ªü ƒë√¢u kh√°c (m·∫∑c d√π c√≥ th·ªÉ). "An to√†n" ·ªü ƒë√¢y ch·ªß y·∫øu ƒë·ªÅ c·∫≠p ƒë·∫øn vi·ªác th√¥ng tin c√≥ th·ªÉ ƒë∆∞·ª£c **x√°c minh t√≠nh to√†n v·∫πn** v√† **ngu·ªìn g·ªëc** nh·ªù v√†o ch·ªØ k√Ω s·ªë.

C√°c tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng ch√≠nh c·ªßa JWT bao g·ªìm:

*   **X√°c th·ª±c (Authentication):** ƒê√¢y l√† ·ª©ng d·ª•ng ph·ªï bi·∫øn nh·∫•t. Sau khi ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p th√†nh c√¥ng, server c·∫•p m·ªôt JWT. Client l∆∞u l·∫°i v√† g·ª≠i k√®m JWT n√†y trong c√°c y√™u c·∫ßu sau ƒë·ªÉ ch·ª©ng minh m√¨nh ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c. Server ch·ªâ c·∫ßn ki·ªÉm tra ch·ªØ k√Ω ƒë·ªÉ tin t∆∞·ªüng y√™u c·∫ßu ƒë√≥.
*   **·ª¶y quy·ªÅn (Authorization):** JWT c√≥ th·ªÉ ch·ª©a th√¥ng tin v·ªÅ vai tr√≤ (roles) ho·∫∑c quy·ªÅn h·∫°n (permissions) c·ªßa ng∆∞·ªùi d√πng. Server c√≥ th·ªÉ d·ª±a v√†o ƒë√≥ ƒë·ªÉ quy·∫øt ƒë·ªãnh ng∆∞·ªùi d√πng c√≥ ƒë∆∞·ª£c ph√©p truy c·∫≠p t√†i nguy√™n ho·∫∑c th·ª±c hi·ªán h√†nh ƒë·ªông c·ª• th·ªÉ hay kh√¥ng.
*   **Trao ƒë·ªïi th√¥ng tin (Information Exchange):** JWT l√† m·ªôt c√°ch an to√†n ƒë·ªÉ truy·ªÅn th√¥ng tin gi·ªØa c√°c d·ªãch v·ª• (v√≠ d·ª•: trong ki·∫øn tr√∫c microservices) v√¨ ch·ªØ k√Ω ƒë·∫£m b·∫£o d·ªØ li·ªáu kh√¥ng b·ªã thay ƒë·ªïi v√† ƒë·∫øn t·ª´ ngu·ªìn ƒë√°ng tin c·∫≠y.

### 2. Gi·∫£i ph·∫´u JWT: C·∫•u tr√∫c 3 ph·∫ßn V√†ng

M·ªçi JWT ƒë·ªÅu c√≥ c·∫•u tr√∫c g·ªìm 3 ph·∫ßn, ngƒÉn c√°ch b·ªüi d·∫•u ch·∫•m (`.`), m·ªói ph·∫ßn ƒë∆∞·ª£c m√£ h√≥a b·∫±ng **Base64Url Encoding** (an to√†n cho URL, kh√°c Base64 chu·∫©n m·ªôt ch√∫t ·ªü k√Ω t·ª± `+`, `/` v√† padding `=`):

`HEADER.PAYLOAD.SIGNATURE`

**V√≠ d·ª• m·ªôt chu·ªói JWT ƒëi·ªÉn h√¨nh:**

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJleHAiOjE1MTYyNDI2MjJ9.4BGe9hAduz0Yg-Eq3-aPAsn3GP14qh4UTbxJ53X0j58
```

H√£y c√πng "m·ªï x·∫ª" t·ª´ng th√†nh ph·∫ßn:

#### 2.1. Header (Ti√™u ƒë·ªÅ)

*   **M·ª•c ƒë√≠ch:** Ch·ª©a th√¥ng tin v·ªÅ c√°ch t·∫°o ra ch·ªØ k√Ω v√† lo·∫°i token.
*   **N·ªôi dung:** L√† m·ªôt ƒë·ªëi t∆∞·ª£ng JSON, th∆∞·ªùng c√≥ 2 tr∆∞·ªùng ch√≠nh:
    *   `alg` (Algorithm): Thu·∫≠t to√°n ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ t·∫°o ch·ªØ k√Ω (Signature). V√≠ d·ª•: `HS256`, `RS256`, `ES256`. ƒê√¢y l√† tr∆∞·ªùng **b·∫Øt bu·ªôc**.
    *   `typ` (Type): Lo·∫°i token, th∆∞·ªùng lu√¥n l√† `"JWT"`.
*   **V√≠ d·ª• (JSON g·ªëc):**
    ```json
    {
      "alg": "HS256",
      "typ": "JWT"
    }
    ```
*   **M√£ h√≥a:** JSON n√†y ƒë∆∞·ª£c m√£ h√≥a Base64Url th√†nh ph·∫ßn ƒë·∫ßu ti√™n:
    `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9`

#### 2.2. Payload (T·∫£i tr·ªçng - N∆°i ch·ª©a Claims)

*   **M·ª•c ƒë√≠ch:** Ch·ª©a c√°c "Claims" (tuy√™n b·ªë) - l√† c√°c m·∫©u th√¥ng tin v·ªÅ ch·ªß th·ªÉ (th∆∞·ªùng l√† ng∆∞·ªùi d√πng) v√† c√°c d·ªØ li·ªáu ng·ªØ c·∫£nh kh√°c.
*   **N·ªôi dung:** L√† m·ªôt ƒë·ªëi t∆∞·ª£ng JSON ch·ª©a c√°c c·∫∑p key-value (claims). C√≥ 3 lo·∫°i claims:
    *   **Registered Claims:** C√°c t√™n claim ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a s·∫µn trong chu·∫©n RFC 7519. Ch√∫ng kh√¥ng b·∫Øt bu·ªôc nh∆∞ng ƒë∆∞·ª£c *khuy·∫øn ngh·ªã m·∫°nh m·∫Ω* v√¨ t√≠nh chu·∫©n h√≥a v√† t∆∞∆°ng th√≠ch. M·ªôt s·ªë claims quan tr·ªçng:
        *   `iss` (Issuer): Ai l√† ng∆∞·ªùi/h·ªá th·ªëng ƒë√£ ph√°t h√†nh token n√†y (v√≠ d·ª•: `"https://myauth.service.com"`).
        *   `sub` (Subject): **Ai** l√† ch·ªß th·ªÉ m√† token n√†y ƒë·∫°i di·ªán (th∆∞·ªùng l√† User ID duy nh·∫•t, v√≠ d·ª•: `"auth0|123456789"` ho·∫∑c m·ªôt UUID). ƒê√¢y l√† claim **then ch·ªët** ƒë·ªÉ ƒë·ªãnh danh ng∆∞·ªùi d√πng.
        *   `aud` (Audience): Token n√†y d√†nh cho **ai/d·ªãch v·ª• n√†o** (v√≠ d·ª•: URL c·ªßa API m√† client s·∫Ω g·ªçi: `"https://api.mydomain.com"`). Server nh·∫≠n token *n√™n* ki·ªÉm tra xem m√¨nh c√≥ n·∫±m trong danh s√°ch `aud` kh√¥ng.
        *   `exp` (Expiration Time): Th·ªùi ƒëi·ªÉm (Unix Timestamp t√≠nh b·∫±ng gi√¢y) m√† token **h·∫øt h·∫°n**. Server **ph·∫£i** ki·ªÉm tra claim n√†y v√† t·ª´ ch·ªëi token ƒë√£ h·∫øt h·∫°n. V√≠ d·ª•: `1711533600`.
        *   `nbf` (Not Before): Th·ªùi ƒëi·ªÉm (Unix Timestamp) m√† token b·∫Øt ƒë·∫ßu c√≥ hi·ªáu l·ª±c. Token s·∫Ω b·ªã t·ª´ ch·ªëi *tr∆∞·ªõc* th·ªùi ƒëi·ªÉm n√†y.
        *   `iat` (Issued At): Th·ªùi ƒëi·ªÉm (Unix Timestamp) m√† token ƒë∆∞·ª£c ph√°t h√†nh. H·ªØu √≠ch ƒë·ªÉ bi·∫øt "tu·ªïi" c·ªßa token. V√≠ d·ª•: `1711530000`.
        *   `jti` (JWT ID): M·ªôt ƒë·ªãnh danh duy nh·∫•t (UUID) cho ch√≠nh token n√†y. R·∫•t h·ªØu √≠ch cho vi·ªác theo d√µi v√† ƒë·∫∑c bi·ªát l√† cho c√°c chi·∫øn l∆∞·ª£c thu h·ªìi token (revocation).
    *   **Public Claims:** C√°c claim do ng∆∞·ªùi d√πng t·ª± ƒë·ªãnh nghƒ©a nh∆∞ng c·∫ßn tr√°nh xung ƒë·ªôt t√™n. C√°ch t·ªët nh·∫•t l√† ƒë·∫∑t t√™n d∆∞·ªõi d·∫°ng URI ho·∫∑c s·ª≠ d·ª•ng namespace. V√≠ d·ª•: `"https://mycompany.com/claims/user_level": "gold"`.
    *   **Private Claims:** C√°c claim t·ª± ƒë·ªãnh nghƒ©a, ƒë∆∞·ª£c t·∫°o ra ƒë·ªÉ chia s·∫ª th√¥ng tin gi·ªØa c√°c b√™n ƒë√£ c√≥ th·ªèa thu·∫≠n ng·∫ßm v·ªõi nhau (v√≠ d·ª•: gi·ªØa client v√† server c·ªßa c√πng m·ªôt ·ª©ng d·ª•ng). C√≥ th·ªÉ ƒë·∫∑t t√™n t√πy √Ω nh∆∞ng n√™n tr√°nh tr√πng v·ªõi Registered Claims. V√≠ d·ª•: `"role": "administrator"`, `"department": "Sales"`.
*   **V√≠ d·ª• (JSON g·ªëc):**
    ```json
    {
      "sub": "user-9876",
      "name": "Jane Doe", // Private Claim
      "role": ["editor", "publisher"], // Private Claim
      "iss": "https://secure.myapp.com",
      "aud": "https://api.myapp.com",
      "iat": 1678886400, // March 15, 2023 12:00:00 PM UTC
      "exp": 1678890000, // March 15, 2023 01:00:00 PM UTC (1 hour later)
      "jti": "f8a4b1e2-c3d4-5e6f-7a8b-9c0d1e2f3a4b"
    }
    ```
*   **M√£ h√≥a:** JSON n√†y ƒë∆∞·ª£c m√£ h√≥a Base64Url th√†nh ph·∫ßn th·ª© hai:
    `eyJzdWIiOiJ1c2VyLTk4NzYiLCJuYW1lIjoiSmFuZSBEb2UiLCJyb2xlIjpbImVkaXRvciIsInB1Ymxpc2hlciJdLCJpc3MiOiJodHRwczovL3NlY3VyZS5teWFwcC5jb20iLCJhdWQiOiJodHRwczovL2FwaS5teWFwcC5jb20iLCJpYXQiOjE2Nzg4ODY0MDAsImV4cCI6MTY3ODg5MDAwMCwianRpIjoiZjhhNGIxZTItYzNkNC01ZTZmLTdhOGItOWMwZDFlMmYzYTRiIn0`
*   üö® **C·∫¢NH B√ÅO B·∫¢O M·∫¨T T·ªêI QUAN TR·ªåNG:** Payload ch·ªâ ƒë∆∞·ª£c m√£ h√≥a Base64Url, nghƒ©a l√† **b·∫•t k·ª≥ ai c√≥ ƒë∆∞·ª£c token ƒë·ªÅu c√≥ th·ªÉ gi·∫£i m√£ v√† ƒë·ªçc n·ªôi dung c·ªßa n√≥ m·ªôt c√°ch d·ªÖ d√†ng**. Gi·ªëng nh∆∞ th√¥ng tin ghi tr√™n b∆∞u thi·∫øp v·∫≠y. Do ƒë√≥:
    *   **TUY·ªÜT ƒê·ªêI KH√îNG BAO GI·ªú** l∆∞u tr·ªØ th√¥ng tin c·ª±c k·ª≥ nh·∫°y c·∫£m nh∆∞: m·∫≠t kh·∫©u (k·ªÉ c·∫£ hash), kh√≥a API b√≠ m·∫≠t, s·ªë th·∫ª t√≠n d·ª•ng, m√£ PIN, th√¥ng tin ƒë·ªãnh danh c√° nh√¢n (PII) chi ti·∫øt v√† nh·∫°y c·∫£m (s·ªë an sinh x√£ h·ªôi, chi ti·∫øt t√†i kho·∫£n ng√¢n h√†ng...).
    *   Ch·ªâ n√™n ch·ª©a th√¥ng tin ƒë·ªãnh danh (`sub`), th√¥ng tin ph√¢n quy·ªÅn c∆° b·∫£n (roles - n·∫øu kh√¥ng qu√° nhi·ªÅu), th√¥ng tin qu·∫£n l√Ω phi√™n (`exp`, `iat`, `jti`), v√† c√°c d·ªØ li·ªáu ƒë·ªãnh danh ng·ªØ c·∫£nh kh√¥ng qu√° nh·∫°y c·∫£m kh√°c.

---

## Ph·∫ßn 2: Ch·ªØ k√Ω s·ªë, B·∫£o m·∫≠t v√† So s√°nh v·ªõi Session

### 2.3. Signature (Ch·ªØ k√Ω s·ªë) - Con d·∫•u B·∫£o ƒë·∫£m

ƒê√¢y l√† ph·∫ßn th·ª© ba v√† c≈©ng l√† ph·∫ßn quan tr·ªçng nh·∫•t ƒë·∫£m b·∫£o t√≠nh b·∫£o m·∫≠t c·ªët l√µi c·ªßa JWT. N·∫øu Header v√† Payload gi·ªëng nh∆∞ n·ªôi dung c·ªßa t·∫•m h·ªô chi·∫øu, th√¨ Signature ch√≠nh l√† con d·∫•u v√† c√°c y·∫øu t·ªë b·∫£o an ch·ªëng l√†m gi·∫£.

*   **M·ª•c ƒë√≠ch:** Ch·ªØ k√Ω ƒë√≥ng hai vai tr√≤ s·ªëng c√≤n:
    1.  **ƒê·∫£m b·∫£o T√≠nh to√†n v·∫πn (Integrity):** N√≥ x√°c nh·∫≠n r·∫±ng d·ªØ li·ªáu trong Header v√† Payload **kh√¥ng h·ªÅ b·ªã thay ƒë·ªïi** k·ªÉ t·ª´ khi token ƒë∆∞·ª£c c·∫•p ph√°t. B·∫•t k·ª≥ s·ª± s·ª≠a ƒë·ªïi n√†o, d√π nh·ªè nh·∫•t, c≈©ng s·∫Ω l√†m cho ch·ªØ k√Ω kh√¥ng c√≤n kh·ªõp khi ƒë∆∞·ª£c x√°c minh.
    2.  **X√°c th·ª±c Ngu·ªìn g·ªëc / Ng∆∞·ªùi g·ª≠i (Authenticity):** V√¨ vi·ªác t·∫°o ra ch·ªØ k√Ω y√™u c·∫ßu m·ªôt kh√≥a b√≠ m·∫≠t (Secret Key) ho·∫∑c kh√≥a ri√™ng t∆∞ (Private Key) m√† ch·ªâ ng∆∞·ªùi/h·ªá th·ªëng c·∫•p ph√°t token h·ª£p l·ªá m·ªõi s·ªü h·ªØu, n√™n m·ªôt ch·ªØ k√Ω h·ª£p l·ªá ch·ª©ng minh r·∫±ng token ƒë√≥ **th·ª±c s·ª± ƒë∆∞·ª£c t·∫°o ra b·ªüi ngu·ªìn ƒë√°ng tin c·∫≠y**, kh√¥ng ph·∫£i gi·∫£ m·∫°o.

*   **C√°ch t·∫°o ch·ªØ k√Ω:** Qu√° tr√¨nh n√†y s·ª≠ d·ª•ng ba th√†nh ph·∫ßn ƒë·∫ßu v√†o:
    1.  **Encoded Header:** Ph·∫ßn Header ƒë√£ m√£ h√≥a Base64Url.
    2.  **Encoded Payload:** Ph·∫ßn Payload ƒë√£ m√£ h√≥a Base64Url.
    3.  **Kh√≥a b√≠ m·∫≠t (Secret) ho·∫∑c Kh√≥a ri√™ng t∆∞ (Private Key):**
        *   V·ªõi thu·∫≠t to√°n ƒë·ªëi x·ª©ng (HMAC): M·ªôt chu·ªói b√≠ m·∫≠t (Secret Key) duy nh·∫•t.
        *   V·ªõi thu·∫≠t to√°n b·∫•t ƒë·ªëi x·ª©ng (RSA, ECDSA): Kh√≥a ri√™ng t∆∞ (Private Key) c·ªßa ng∆∞·ªùi c·∫•p ph√°t.
    Qu√° tr√¨nh di·ªÖn ra nh∆∞ sau:
    ```
    // 1. Gh√©p n·ªëi Header v√† Payload ƒë√£ m√£ h√≥a
    dataToSign = base64UrlEncode(Header) + "." + base64UrlEncode(Payload)

    // 2. √Åp d·ª•ng thu·∫≠t to√°n k√Ω ƒë√£ ch·ªçn trong Header (`alg`) v·ªõi Kh√≥a t∆∞∆°ng ·ª©ng
    rawSignature = signFunction(dataToSign, Key)
    // V√≠ d·ª•: rawSignature = HMACSHA256(dataToSign, secretKey)
    // Ho·∫∑c: rawSignature = SignWithRSA_SHA256(dataToSign, privateKey)

    // 3. M√£ h√≥a k·∫øt qu·∫£ ch·ªØ k√Ω th√¥ b·∫±ng Base64Url
    signature = base64UrlEncode(rawSignature)
    ```
    Chu·ªói `signature` n√†y ch√≠nh l√† ph·∫ßn th·ª© ba c·ªßa JWT.

*   **C√°c Thu·∫≠t to√°n K√Ω Ph·ªï bi·∫øn (`alg`):**
    *   **HMAC (vd: `HS256`, `HS384`, `HS512`)**
        *   **Lo·∫°i:** ƒê·ªëi x·ª©ng (Symmetric).
        *   **C∆° ch·∫ø:** S·ª≠ d·ª•ng **m·ªôt kh√≥a b√≠ m·∫≠t (Secret Key)** duy nh·∫•t cho c·∫£ vi·ªác *k√Ω* v√† *x√°c minh*. Gi·ªëng nh∆∞ m·ªôt m·∫≠t kh·∫©u chung.
        *   **∆Øu ƒëi·ªÉm:** Nhanh v√† ƒë∆°n gi·∫£n h∆°n v·ªÅ m·∫∑t t√≠nh to√°n.
        *   **Nh∆∞·ª£c ƒëi·ªÉm:** C·∫£ b√™n k√Ω v√† b√™n x√°c minh ph·∫£i bi·∫øt v√† b·∫£o v·ªá c√πng m·ªôt kh√≥a b√≠ m·∫≠t. N·∫øu kh√≥a b·ªã l·ªô ·ªü b·∫•t k·ª≥ ƒë√¢u, k·∫ª t·∫•n c√¥ng c√≥ th·ªÉ t·∫°o token gi·∫£ m·∫°o. Vi·ªác chia s·∫ª kh√≥a b√≠ m·∫≠t an to√†n cho nhi·ªÅu b√™n x√°c minh c√≥ th·ªÉ ph·ª©c t·∫°p.
        *   **Khi n√†o d√πng:** Ph√π h·ª£p khi vi·ªác k√Ω v√† x√°c minh di·ªÖn ra trong c√πng m·ªôt ·ª©ng d·ª•ng/h·ªá th·ªëng, ho·∫∑c gi·ªØa c√°c microservice n·ªôi b·ªô r·∫•t tin c·∫≠y nhau v√† c√≥ k√™nh chia s·∫ª b√≠ m·∫≠t an to√†n.
    *   **RSA / ECDSA (vd: `RS256`, `RS384`, `RS512`, `ES256`, `ES384`, `ES512`)**
        *   **Lo·∫°i:** B·∫•t ƒë·ªëi x·ª©ng (Asymmetric).
        *   **C∆° ch·∫ø:** S·ª≠ d·ª•ng m·ªôt c·∫∑p kh√≥a: **Kh√≥a ri√™ng t∆∞ (Private Key)** v√† **Kh√≥a c√¥ng khai (Public Key)**.
            *   Ch·ªâ **Private Key** (ph·∫£i ƒë∆∞·ª£c gi·ªØ tuy·ªát m·∫≠t b·ªüi ng∆∞·ªùi c·∫•p ph√°t) m·ªõi c√≥ th·ªÉ *t·∫°o* ch·ªØ k√Ω.
            *   **Public Key** (c√≥ th·ªÉ chia s·∫ª r·ªông r√£i) ƒë∆∞·ª£c d√πng ƒë·ªÉ *x√°c minh* ch·ªØ k√Ω.
        *   **∆Øu ƒëi·ªÉm:** An to√†n h∆°n cho h·ªá th·ªëng ph√¢n t√°n. B√™n x√°c minh (v√≠ d·ª•: c√°c API servers) ch·ªâ c·∫ßn Public Key, kh√¥ng th·ªÉ t·∫°o token gi·∫£. Cho ph√©p b√™n th·ª© ba d·ªÖ d√†ng x√°c minh token m√† kh√¥ng c·∫ßn bi·∫øt b√≠ m·∫≠t c·ªßa ng∆∞·ªùi c·∫•p ph√°t.
        *   **Nh∆∞·ª£c ƒëi·ªÉm:** Th∆∞·ªùng ch·∫≠m h∆°n HMAC v·ªÅ m·∫∑t t√≠nh to√°n. Vi·ªác qu·∫£n l√Ω c·∫∑p kh√≥a (t·∫°o, l∆∞u tr·ªØ private key an to√†n, ph√¢n ph·ªëi public key) ph·ª©c t·∫°p h∆°n.
        *   **Khi n√†o d√πng:** L√Ω t∆∞·ªüng cho ki·∫øn tr√∫c microservices n∆°i m·ªôt Identity Provider (IdP) trung t√¢m c·∫•p token v√† nhi·ªÅu Resource Server kh√°c nhau c·∫ßn x√°c minh; C√°c k·ªãch b·∫£n Single Sign-On (SSO); Khi c·∫ßn c·∫•p token cho c√°c ƒë·ªëi t√°c ho·∫∑c ·ª©ng d·ª•ng b√™n th·ª© ba.

*   **T·∫ßm quan tr·ªçng c·ªßa vi·ªác B·∫£o m·∫≠t Kh√≥a:** ƒê√¢y l√† ƒëi·ªÉm y·∫øu ch√≠ m·∫°ng n·∫øu kh√¥ng ƒë∆∞·ª£c qu·∫£n l√Ω c·∫©n th·∫≠n.
    *   M·∫•t **Secret Key (HMAC)** ho·∫∑c **Private Key (RSA/ECDSA)** ƒë·ªìng nghƒ©a v·ªõi vi·ªác **to√†n b·ªô h·ªá th·ªëng x√°c th·ª±c JWT b·ªã v√¥ hi·ªáu h√≥a**. K·∫ª t·∫•n c√¥ng c√≥ th·ªÉ t·ª± do t·∫°o ra b·∫•t k·ª≥ token gi·∫£ m·∫°o n√†o v·ªõi ch·ªØ k√Ω h·ª£p l·ªá, m·∫°o danh ng∆∞·ªùi d√πng v√† chi·∫øm quy·ªÅn truy c·∫≠p.
    *   Vi·ªác b·∫£o v·ªá c√°c kh√≥a n√†y l√† ∆∞u ti√™n h√†ng ƒë·∫ßu (s·∫Ω ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p k·ªπ h∆°n ·ªü ph·∫ßn b·∫£o m·∫≠t).

### 3. JWT: K√Ω (Signing) ‚â† M√£ h√≥a (Encryption)

M·ªôt l·∫ßn n·ªØa, c·∫ßn ph·∫£i nh·∫•n m·∫°nh s·ª± kh√°c bi·ªát c∆° b·∫£n n√†y:

*   **JWT (JWS - JSON Web Signature):** M·ª•c ƒë√≠ch ch√≠nh l√† **x√°c th·ª±c** v√† **ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn** th√¥ng qua **Ch·ªØ k√Ω s·ªë (Signing)**. N√≥ **KH√îNG** che gi·∫•u n·ªôi dung Payload theo m·∫∑c ƒë·ªãnh.
*   **Base64Url Encoding:** Ch·ªâ l√† ph∆∞∆°ng th·ª©c m√£ h√≥a d·ªØ li·ªáu ƒë·ªÉ truy·ªÅn t·∫£i an to√†n qua c√°c k√™nh text-based (nh∆∞ HTTP header, URL), **ho√†n to√†n c√≥ th·ªÉ gi·∫£i m√£ (decode)** d·ªÖ d√†ng.
*   **Encryption (M√£ h√≥a b·∫£o m·∫≠t):** L√† qu√° tr√¨nh l√†m cho d·ªØ li·ªáu kh√¥ng th·ªÉ ƒë·ªçc ƒë∆∞·ª£c n·∫øu kh√¥ng c√≥ kh√≥a gi·∫£i m√£ (decryption key). N·∫øu b·∫°n th·ª±c s·ª± c·∫ßn b·∫£o v·ªá *n·ªôi dung* c·ªßa JWT kh·ªèi b·ªã ƒë·ªçc tr·ªôm, b·∫°n ph·∫£i s·ª≠ d·ª•ng m·ªôt chu·∫©n kh√°c l√† **JWE (JSON Web Encryption)**, ph·ª©c t·∫°p h∆°n ƒë√°ng k·ªÉ.

**=> H√£y lu√¥n coi Payload c·ªßa JWS l√† th√¥ng tin c√≥ th·ªÉ ƒë·ªçc ƒë∆∞·ª£c.**

### 4. So s√°nh JWT v·ªõi X√°c th·ª±c d·ª±a tr√™n Session

ƒê·ªÉ th·∫•y r√µ ∆∞u ƒëi·ªÉm c·ªßa JWT, h√£y so s√°nh n√≥ v·ªõi ph∆∞∆°ng ph√°p x√°c th·ª±c truy·ªÅn th·ªëng d·ª±a tr√™n Session:

| T√≠nh nƒÉng              | Session-Based Authentication                                     | JWT-Based Authentication                                          |
| :--------------------- | :--------------------------------------------------------------- | :---------------------------------------------------------------- |
| **L∆∞u tr·ªØ tr·∫°ng th√°i** | **Stateful:** Server ph·∫£i l∆∞u tr·ªØ d·ªØ li·ªáu session (trong b·ªô nh·ªõ, DB, cache). | **Stateless (ch·ªß y·∫øu):** Server kh√¥ng c·∫ßn l∆∞u tr·∫°ng th√°i phi√™n. Th√¥ng tin n·∫±m trong token. |
| **D·ªØ li·ªáu phi√™n**     | ID phi√™n (th∆∞·ªùng trong cookie) ƒë∆∞·ª£c g·ª≠i t·ª´ client. Server tra c·ª©u d·ªØ li·ªáu session t∆∞∆°ng ·ª©ng. | To√†n b·ªô th√¥ng tin c·∫ßn thi·∫øt (claims) n·∫±m trong Payload c·ªßa token. |
| **Scalability**        | Kh√≥ scale ngang h∆°n. C·∫ßn c∆° ch·∫ø ƒë·ªìng b·ªô session ho·∫∑c sticky session (binding client t·ªõi 1 server). | D·ªÖ d√†ng scale ngang. B·∫•t k·ª≥ server n√†o c√≥ kh√≥a ƒë·ªÅu x√°c th·ª±c ƒë∆∞·ª£c token. |
| **Hi·ªáu su·∫•t Server**  | C·∫ßn I/O (ƒë·ªçc/ghi) ƒë·ªÉ truy c·∫≠p d·ªØ li·ªáu session tr√™n server.       | Ch·ªâ c·∫ßn t√≠nh to√°n CPU ƒë·ªÉ x√°c th·ª±c ch·ªØ k√Ω (th∆∞·ªùng nhanh h∆°n I/O). |
| **Microservices/APIs** | Kh√≥ khƒÉn h∆°n trong vi·ªác chia s·∫ª session gi·ªØa c√°c d·ªãch v·ª• kh√°c nhau. | **R·∫•t ph√π h·ª£p.** Token d·ªÖ d√†ng truy·ªÅn gi·ªØa c√°c d·ªãch v·ª•.             |
| **Mobile Apps**        | Qu·∫£n l√Ω cookie c√≥ th·ªÉ ph·ª©c t·∫°p h∆°n.                                | D·ªÖ d√†ng l∆∞u v√† g·ª≠i token trong header `Authorization`.             |
| **Cross-Domain (CORS)**| Cookie c√≥ th·ªÉ g·∫∑p v·∫•n ƒë·ªÅ v·ªõi ch√≠nh s√°ch same-origin.            | D·ªÖ d√†ng h∆°n khi g·ª≠i token trong header `Authorization`.            |
| **CSRF**               | D·ªÖ b·ªã t·∫•n c√¥ng CSRF n·∫øu ch·ªâ d√πng session cookie. C·∫ßn th√™m token ch·ªëng CSRF. | N·∫øu l∆∞u token trong `localStorage`, √≠t b·ªã CSRF h∆°n cookie. N·∫øu d√πng cookie, v·∫´n c·∫ßn c·ªù `SameSite`. |
| **XSS**                | R·ªßi ro n·∫øu session ID b·ªã l·ªô qua XSS (nh∆∞ng kh√≥ h∆°n).              | **R·ªßi ro cao** n·∫øu token l∆∞u trong `localStorage`/`sessionStorage` b·ªã l·ªô qua XSS. `HttpOnly` cookie an to√†n h∆°n. |
| **K√≠ch th∆∞·ªõc Token**    | Session ID th∆∞·ªùng nh·ªè.                                           | JWT c√≥ th·ªÉ l·ªõn h∆°n n·∫øu ch·ª©a nhi·ªÅu claims. Header HTTP c√≥ gi·ªõi h·∫°n k√≠ch th∆∞·ªõc. |
| **Thu h·ªìi (Revocation)**| **D·ªÖ d√†ng:** Ch·ªâ c·∫ßn x√≥a session tr√™n server.                      | **Kh√≥ khƒÉn h∆°n:** Token h·ª£p l·ªá cho ƒë·∫øn khi h·∫øt h·∫°n. C·∫ßn c√°c chi·∫øn l∆∞·ª£c ph·ª©c t·∫°p (blacklist, refresh token...). |
| **Chu·∫©n h√≥a**          | √çt chu·∫©n h√≥a h∆°n v·ªÅ c√°ch l∆∞u tr·ªØ/qu·∫£n l√Ω session.               | **Chu·∫©n h√≥a (RFC 7519)**, nhi·ªÅu th∆∞ vi·ªán h·ªó tr·ª£.                   |

**T√≥m l·∫°i:** JWT t·ªèa s√°ng nh·ªù t√≠nh **stateless**, **scalability**, v√† s·ª± ph√π h·ª£p v·ªõi ki·∫øn tr√∫c **microservices/APIs**, nh∆∞ng ƒëi k√®m v·ªõi nh·ªØng th√°ch th·ª©c v·ªÅ **b·∫£o m·∫≠t l∆∞u tr·ªØ token ph√≠a client (XSS)**, **k√≠ch th∆∞·ªõc token**, v√† **ƒë·ªô ph·ª©c t·∫°p c·ªßa vi·ªác thu h·ªìi token**.

---

## Ph·∫ßn 3: Lu·ªìng Ho·∫°t ƒë·ªông X√°c th·ª±c JWT trong Th·ª±c t·∫ø

B√¢y gi·ªù ch√∫ng ta ƒë√£ hi·ªÉu c·∫•u tr√∫c c·ªßa JWT, h√£y xem c√°ch n√≥ ƒë∆∞·ª£c s·ª≠ d·ª•ng trong m·ªôt quy tr√¨nh x√°c th·ª±c ƒëƒÉng nh·∫≠p v√† truy c·∫≠p t√†i nguy√™n ƒë∆∞·ª£c b·∫£o v·ªá.

**B·ªëi c·∫£nh:** Ng∆∞·ªùi d√πng (Alice) mu·ªën ƒëƒÉng nh·∫≠p v√†o ·ª©ng d·ª•ng web `myapp.com` v√† truy c·∫≠p v√†o trang h·ªì s∆° c√° nh√¢n (`/api/profile`), m·ªôt t√†i nguy√™n y√™u c·∫ßu x√°c th·ª±c.

**C√°c b∆∞·ªõc di·ªÖn ra nh∆∞ sau:**

**B∆∞·ªõc 1: Y√™u c·∫ßu ƒêƒÉng nh·∫≠p (Client ‚Üí Server)**

1.  **Alice nh·∫≠p th√¥ng tin:** Alice m·ªü trang ƒëƒÉng nh·∫≠p c·ªßa `myapp.com` v√† nh·∫≠p username (`alice@example.com`) c√πng m·∫≠t kh·∫©u (`herSecretPassword`).
2.  **Client g·ª≠i y√™u c·∫ßu:** Khi Alice nh·∫•n n√∫t "ƒêƒÉng nh·∫≠p", JavaScript ph√≠a client (ho·∫∑c ·ª©ng d·ª•ng di ƒë·ªông) t·∫°o m·ªôt y√™u c·∫ßu `POST` g·ª≠i ƒë·∫øn endpoint x√°c th·ª±c c·ªßa server (v√≠ d·ª•: `/api/auth/login`).
    *   **Quan tr·ªçng:** Y√™u c·∫ßu n√†y **ph·∫£i** ƒë∆∞·ª£c g·ª≠i qua **HTTPS** ƒë·ªÉ m√£ h√≥a username v√† m·∫≠t kh·∫©u tr√™n ƒë∆∞·ªùng truy·ªÅn.
    *   Credentials th∆∞·ªùng ƒë∆∞·ª£c g·ª≠i trong ph·∫ßn body c·ªßa request d∆∞·ªõi d·∫°ng JSON.

    ```http
    POST /api/auth/login HTTP/1.1
    Host: myapp.com
    Content-Type: application/json
    Connection: keep-alive
    Accept: application/json

    {
      "email": "alice@example.com",
      "password": "herSecretPassword"
    }
    ```

**B∆∞·ªõc 2: X√°c th·ª±c Th√¥ng tin & T·∫°o JWT (Server)**

1.  **Server nh·∫≠n y√™u c·∫ßu:** Server nh·∫≠n y√™u c·∫ßu `POST` t·∫°i `/api/auth/login`.
2.  **X√°c th·ª±c Credentials:**
    *   Server l·∫•y `email` v√† `password` t·ª´ body request.
    *   Truy v·∫•n c∆° s·ªü d·ªØ li·ªáu ƒë·ªÉ t√¨m ng∆∞·ªùi d√πng c√≥ `email` t∆∞∆°ng ·ª©ng.
    *   N·∫øu t√¨m th·∫•y ng∆∞·ªùi d√πng: Server s·ª≠ d·ª•ng m·ªôt thu·∫≠t to√°n hash m·∫°nh (nh∆∞ bcrypt, Argon2) ƒë·ªÉ so s√°nh `password` ng∆∞·ªùi d√πng g·ª≠i l√™n v·ªõi **hash c·ªßa m·∫≠t kh·∫©u** ƒë∆∞·ª£c l∆∞u tr·ªØ an to√†n trong database. **Tuy·ªát ƒë·ªëi kh√¥ng l∆∞u m·∫≠t kh·∫©u d·∫°ng plain text!**
    *   N·∫øu kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ho·∫∑c m·∫≠t kh·∫©u kh√¥ng kh·ªõp: Server tr·∫£ v·ªÅ l·ªói x√°c th·ª±c (v√≠ d·ª•: HTTP status `401 Unauthorized`).
3.  **T·∫°o JWT (N·∫øu x√°c th·ª±c th√†nh c√¥ng):**
    *   Server quy·∫øt ƒë·ªãnh thu·∫≠t to√°n k√Ω (v√≠ d·ª•: `HS256`).
    *   **T·∫°o Header:** `{ "alg": "HS256", "typ": "JWT" }`.
    *   **T·∫°o Payload:** Bao g·ªìm c√°c claims c·∫ßn thi·∫øt. T·ªëi thi·ªÉu n√™n c√≥ `sub` (User ID c·ªßa Alice l·∫•y t·ª´ DB), `exp` (th·ªùi gian h·∫øt h·∫°n ng·∫Øn, v√≠ d·ª• 15 ph√∫t sau), `iat` (th·ªùi ƒëi·ªÉm hi·ªán t·∫°i). C√≥ th·ªÉ th√™m `role`, `name`...
        ```json
        {
          "sub": "user-alice-1a2b3c",
          "name": "Alice Example",
          "role": "member",
          "iss": "https://myapp.com", // Issuer l√† ch√≠nh server n√†y
          "aud": "https://myapp.com/api", // Audience l√† API c·ªßa server
          "iat": 1711540000, // Th·ªùi ƒëi·ªÉm t·∫°o
          "exp": 1711540900  // H·∫øt h·∫°n sau 15 ph√∫t (900 gi√¢y)
        }
        ```
    *   **T·∫°o Signature:** Server l·∫•y Kh√≥a b√≠ m·∫≠t (Secret Key) ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh an to√†n, √°p d·ª•ng thu·∫≠t to√°n `HS256` l√™n `base64UrlEncode(Header) + "." + base64UrlEncode(Payload)` ƒë·ªÉ t·∫°o ch·ªØ k√Ω.
    *   **Gh√©p n·ªëi:** Server k·∫øt h·ª£p 3 ph·∫ßn ƒë√£ m√£ h√≥a Base64Url th√†nh chu·ªói JWT ho√†n ch·ªânh.

**B∆∞·ªõc 3: G·ª≠i JWT v·ªÅ Client (Server ‚Üí Client)**

1.  **Server ph·∫£n h·ªìi:** Sau khi t·∫°o JWT th√†nh c√¥ng, server g·ª≠i l·∫°i m·ªôt response `200 OK` cho client.
2.  **G·ª≠i Token:** Chu·ªói JWT (th∆∞·ªùng g·ªçi l√† `accessToken`) ƒë∆∞·ª£c ƒë·∫∑t trong body c·ªßa response, th∆∞·ªùng l√† m·ªôt ƒë·ªëi t∆∞·ª£ng JSON.
    *   **Khuy·∫øn ngh·ªã:** Server c≈©ng n√™n t·∫°o v√† g·ª≠i k√®m m·ªôt `refreshToken` (s·∫Ω n√≥i r√µ ·ªü ph·∫ßn sau) c√≥ th·ªùi h·∫°n d√†i h∆°n v√† ƒë∆∞·ª£c x·ª≠ l√Ω kh√°c v·ªõi `accessToken`.

    ```http
    HTTP/1.1 200 OK
    Content-Type: application/json
    Cache-Control: no-store
    Pragma: no-cache
    // Set-Cookie: refreshToken=xyzabc...; HttpOnly; Secure; SameSite=Strict; Path=/api/auth/refresh; Max-Age=... (N·∫øu d√πng cookie cho refresh token)

    {
      "message": "Login successful",
      "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyLWFsaWNlLTFhMmIzYyIsIm5hbWUiOiJBbGljZSBFeGFtcGxlIiwicm9sZSI6Im1lbWJlciIsImlzcyI6Imh0dHBzOi8vbXlhcHAuY29tIiwiYXVkIjoiaHR0cHM6Ly9teWFwcC5jb20vYXBpIiwiaWF0IjoxNzExNTQwMDAwLCJleHAiOjE3MTE1NDA5MDB9.SOME_VALID_HS256_SIGNATURE"
      // , "refreshToken": "def456..." // N·∫øu kh√¥ng d√πng cookie
    }
    ```

**B∆∞·ªõc 4: L∆∞u tr·ªØ JWT (Client)**

1.  **Client nh·∫≠n Token:** Client (JavaScript trong tr√¨nh duy·ªát c·ªßa Alice) nh·∫≠n ƒë∆∞·ª£c response ch·ª©a `accessToken` (v√† c√≥ th·ªÉ c·∫£ `refreshToken`).
2.  **L∆∞u tr·ªØ an to√†n:** Client c·∫ßn l∆∞u tr·ªØ (c√°c) token n√†y ƒë·ªÉ s·ª≠ d·ª•ng cho c√°c y√™u c·∫ßu sau. ƒê√¢y l√† m·ªôt ƒëi·ªÉm **r·∫•t quan tr·ªçng v·ªÅ b·∫£o m·∫≠t**. C√°c l·ª±a ch·ªçn ph·ªï bi·∫øn v√† ƒë√°nh ƒë·ªïi:
    *   **`localStorage` / `sessionStorage` (Web Storage):**
        *   *∆Øu:* API ƒë∆°n gi·∫£n (`localStorage.setItem('accessToken', token)`), `localStorage` gi·ªØ l·∫°i token ngay c·∫£ khi ƒë√≥ng tr√¨nh duy·ªát.
        *   *Nh∆∞·ª£c:* **C·ª±c k·ª≥ d·ªÖ b·ªã t·∫•n c√¥ng XSS (Cross-Site Scripting).** N·∫øu trang web c√≥ l·ªó h·ªïng XSS, m√£ ƒë·ªôc c√≥ th·ªÉ ch·∫°y v√† ƒë·ªçc *to√†n b·ªô* n·ªôi dung trong `localStorage/sessionStorage`, bao g·ªìm c·∫£ token, d·∫´n ƒë·∫øn vi·ªác b·ªã ƒë√°nh c·∫Øp phi√™n ƒëƒÉng nh·∫≠p. **Kh√¥ng khuy·∫øn ngh·ªã cho vi·ªác l∆∞u tr·ªØ token nh·∫°y c·∫£m nh∆∞ Refresh Token.**
    *   **`HttpOnly` Cookie:**
        *   *∆Øu:* **An to√†n h∆°n nhi·ªÅu tr∆∞·ªõc XSS** v√¨ JavaScript ph√≠a client kh√¥ng th·ªÉ truy c·∫≠p ƒë·ªçc/ghi cookie ƒë∆∞·ª£c ƒë√°nh d·∫•u `HttpOnly`. Tr√¨nh duy·ªát t·ª± ƒë·ªông ƒë√≠nh k√®m cookie v√†o c√°c y√™u c·∫ßu g·ª≠i ƒë·∫øn c√πng domain (v√† path) ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh.
        *   *Nh∆∞·ª£c:* C√≥ th·ªÉ b·ªã **t·∫•n c√¥ng CSRF (Cross-Site Request Forgery)** n·∫øu kh√¥ng c·∫•u h√¨nh c·ªù `SameSite` (`Strict` ho·∫∑c `Lax`) m·ªôt c√°ch ch√≠nh x√°c. C√≥ gi·ªõi h·∫°n k√≠ch th∆∞·ªõc (kho·∫£ng 4KB). Vi·ªác c·∫•u h√¨nh `Set-Cookie` header t·ª´ server ph·ª©c t·∫°p h∆°n m·ªôt ch√∫t.
    *   **In-Memory (Bi·∫øn JavaScript):**
        *   *∆Øu:* T∆∞∆°ng ƒë·ªëi an to√†n tr∆∞·ªõc XSS sau khi token ƒë√£ ƒë∆∞·ª£c load v√†o bi·∫øn.
        *   *Nh∆∞·ª£c:* Token s·∫Ω b·ªã m·∫•t ho√†n to√†n khi ng∆∞·ªùi d√πng refresh trang (F5) ho·∫∑c ƒë√≥ng tab/tr√¨nh duy·ªát. Th∆∞·ªùng ch·ªâ ph√π h·ª£p cho `accessToken` trong c√°c SPA ph·ª©c t·∫°p, v√† lu√¥n c·∫ßn ƒëi k√®m c∆° ch·∫ø d√πng `refreshToken` ƒë·ªÉ l·∫•y l·∫°i `accessToken` m·ªõi khi c·∫ßn.
    *   **Khuy·∫øn ngh·ªã ph·ªï bi·∫øn:**
        *   L∆∞u **`refreshToken`** trong **`HttpOnly`, `Secure`, `SameSite=Strict` Cookie**.
        *   L∆∞u **`accessToken`**: C√≥ th·ªÉ l∆∞u trong **bi·∫øn JavaScript (in-memory)** (y√™u c·∫ßu c∆° ch·∫ø refresh khi c·∫ßn) ho·∫∑c c≈©ng c√≥ th·ªÉ l∆∞u trong **`HttpOnly` Cookie** (ƒë∆°n gi·∫£n h∆°n cho vi·ªác g·ª≠i t·ª± ƒë·ªông, nh∆∞ng c·∫ßn c·∫©n th·∫≠n v·ªõi CSRF v√† gi·ªõi h·∫°n k√≠ch th∆∞·ªõc). L∆∞u `accessToken` trong `localStorage` n√™n ƒë∆∞·ª£c c√¢n nh·∫Øc k·ªπ l∆∞·ª°ng v·ªÅ r·ªßi ro XSS.

**B∆∞·ªõc 5: G·ª≠i JWT trong c√°c Y√™u c·∫ßu Ti·∫øp theo (Client ‚Üí Server)**

1.  **Alice truy c·∫≠p trang Profile:** Alice nh·∫•n v√†o link ƒë·ªÉ xem trang h·ªì s∆° c√° nh√¢n (`/profile`) tr√™n `myapp.com`. Tr√¨nh duy·ªát c·∫ßn g·ªçi API `/api/profile` ƒë·ªÉ l·∫•y d·ªØ li·ªáu.
2.  **Client ƒë√≠nh k√®m Token:** Tr∆∞·ªõc khi g·ª≠i y√™u c·∫ßu ƒë·∫øn `/api/profile`, client c·∫ßn l·∫•y `accessToken` ƒë√£ l∆∞u.
    *   **C√°ch ph·ªï bi·∫øn nh·∫•t:** ƒê·∫∑t token v√†o **HTTP Header `Authorization`** s·ª≠ d·ª•ng schema (ki·ªÉu) `Bearer`.
    ```http
    GET /api/profile HTTP/1.1
    Host: myapp.com
    Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyLWFsaWNlLTFhMmIzYyIsIm5hbWUiOiJBbGljZSBFeGFtcGxlIiwicm9sZSI6Im1lbWJlciIsImlzcyI6Imh0dHBzOi8vbXlhcHAuY29tIiwiYXVkIjoiaHR0cHM6Ly9teWFwcC5jb20vYXBpIiwiaWF0IjoxNzExNTQwMDAwLCJleHAiOjE3MTE1NDA5MDB9.SOME_VALID_HS256_SIGNATURE
    Connection: keep-alive
    Accept: application/json
    ```
    *   **N·∫øu d√πng `HttpOnly` Cookie:** Tr√¨nh duy·ªát s·∫Ω t·ª± ƒë·ªông ƒë√≠nh k√®m cookie ch·ª©a token v√†o y√™u c·∫ßu n·∫øu c√°c thu·ªôc t√≠nh domain, path, secure kh·ªõp. Client-side code kh√¥ng c·∫ßn l√†m g√¨ th√™m ·ªü b∆∞·ªõc n√†y. Server s·∫Ω c·∫ßn ƒë·ªçc token t·ª´ cookie thay v√¨ header `Authorization`.

**B∆∞·ªõc 6: X√°c minh JWT (Server)**

1.  **Middleware/Filter ch·∫∑n y√™u c·∫ßu:** Y√™u c·∫ßu `GET /api/profile` ƒë·∫øn server. M·ªôt l·ªõp trung gian (middleware trong Node.js/Express, filter trong Java/Spring, ...) ƒë∆∞·ª£c c·∫•u h√¨nh ƒë·ªÉ b·∫£o v·ªá endpoint n√†y s·∫Ω ch·∫∑n y√™u c·∫ßu l·∫°i tr∆∞·ªõc ti√™n.
2.  **Tr√≠ch xu·∫•t Token:** Middleware t√¨m v√† tr√≠ch xu·∫•t chu·ªói JWT t·ª´ header `Authorization` (b·ªè ƒëi ph·∫ßn `Bearer `) ho·∫∑c t·ª´ cookie (n·∫øu d√πng c√°ch ƒë√≥). N·∫øu kh√¥ng t√¨m th·∫•y token -> Tr·∫£ l·ªói `401 Unauthorized`.
3.  **Th·ª±c hi·ªán X√°c minh (Verification):** ƒê√¢y l√† b∆∞·ªõc quan tr·ªçng nh·∫•t ph√≠a server:
    *   **Ki·ªÉm tra ƒë·ªãnh d·∫°ng:** Token c√≥ ƒë√∫ng c·∫•u tr√∫c 3 ph·∫ßn ngƒÉn c√°ch b·ªüi d·∫•u ch·∫•m kh√¥ng?
    *   **Gi·∫£i m√£ Header:** Decode Base64Url ph·∫ßn header ƒë·ªÉ ƒë·ªçc `alg`.
    *   **Ki·ªÉm tra Thu·∫≠t to√°n (`alg`):** Thu·∫≠t to√°n trong header (`HS256`) c√≥ n·∫±m trong danh s√°ch c√°c thu·∫≠t to√°n ƒë∆∞·ª£c server cho ph√©p kh√¥ng? **Tuy·ªát ƒë·ªëi kh√¥ng ch·∫•p nh·∫≠n `alg: "none"`!**
    *   **Gi·∫£i m√£ Payload:** Decode Base64Url ph·∫ßn payload.
    *   **Ki·ªÉm tra Th·ªùi gian h·∫øt h·∫°n (`exp`):** L·∫•y gi√° tr·ªã `exp` t·ª´ payload. So s√°nh v·ªõi th·ªùi gian hi·ªán t·∫°i c·ªßa server. N·∫øu `exp` <= `th·ªùi_gian_hi·ªán_t·∫°i` -> Token ƒë√£ h·∫øt h·∫°n, tr·∫£ l·ªói `401 Unauthorized`.
    *   *(T√πy ch·ªçn)* **Ki·ªÉm tra c√°c claims kh√°c:** `iss`, `aud` c√≥ kh·ªõp v·ªõi c·∫•u h√¨nh c·ªßa server kh√¥ng? `nbf` (n·∫øu c√≥) ƒë√£ qua ch∆∞a?
    *   *(Quan tr·ªçng nh·∫•t)* **X√°c th·ª±c Ch·ªØ k√Ω (Verify Signature):**
        *   L·∫•y `encodedHeader` v√† `encodedPayload` t·ª´ token nh·∫≠n ƒë∆∞·ª£c.
        *   L·∫•y **ƒë√∫ng Kh√≥a b√≠ m·∫≠t (Secret Key)** (cho HS256) ho·∫∑c **Kh√≥a c√¥ng khai (Public Key)** (cho RS256/ES256) m√† server ƒëang gi·ªØ v√† t∆∞∆°ng ·ª©ng v·ªõi `alg` ƒë√£ x√°c ƒë·ªãnh.
        *   T√≠nh to√°n l·∫°i ch·ªØ k√Ω d·ª± ki·∫øn: `expectedSignature = HMACSHA256(encodedHeader + "." + encodedPayload, secretKey)` (v√≠ d·ª• v·ªõi HS256).
        *   So s√°nh `expectedSignature` (sau khi m√£ h√≥a Base64Url) v·ªõi ph·∫ßn `signature` nh·∫≠n ƒë∆∞·ª£c t·ª´ token.
4.  **K·∫øt qu·∫£ X√°c minh:**
    *   **Th√†nh c√¥ng:** Ch·ªØ k√Ω kh·ªõp v√† m·ªçi ki·ªÉm tra kh√°c ƒë·ªÅu qua! Token h·ª£p l·ªá. Middleware cho ph√©p y√™u c·∫ßu ƒëi ti·∫øp v√†o b·ªô x·ª≠ l√Ω logic ch√≠nh c·ªßa endpoint `/api/profile`. Th√¥ng tin ng∆∞·ªùi d√πng (v√≠ d·ª• `sub` t·ª´ payload) th∆∞·ªùng ƒë∆∞·ª£c middleware g·∫Øn v√†o ƒë·ªëi t∆∞·ª£ng request (vd: `req.user = { id: 'user-alice-1a2b3c', role: 'member' }`) ƒë·ªÉ logic ph√≠a sau s·ª≠ d·ª•ng.
    *   **Th·∫•t b·∫°i:** Ch·ªØ k√Ω kh√¥ng kh·ªõp ho·∫∑c m·ªôt ki·ªÉm tra n√†o ƒë√≥ th·∫•t b·∫°i (h·∫øt h·∫°n, sai `alg`...). Middleware ngay l·∫≠p t·ª©c tr·∫£ v·ªÅ l·ªói cho client, th∆∞·ªùng l√† `401 Unauthorized` (token kh√¥ng h·ª£p l·ªá/h·∫øt h·∫°n) ho·∫∑c `403 Forbidden` (token h·ª£p l·ªá nh∆∞ng kh√¥ng ƒë·ªß quy·ªÅn - ki·ªÉm tra n√†y th∆∞·ªùng di·ªÖn ra sau khi x√°c th·ª±c th√†nh c√¥ng).

Lu·ªìng ho·∫°t ƒë·ªông n√†y, khi ƒë∆∞·ª£c tri·ªÉn khai ƒë√∫ng c√°ch, ƒë·∫£m b·∫£o r·∫±ng ch·ªâ nh·ªØng y√™u c·∫ßu t·ª´ ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c v√† c√≥ token h·ª£p l·ªá m·ªõi c√≥ th·ªÉ truy c·∫≠p v√†o c√°c t√†i nguy√™n ƒë∆∞·ª£c b·∫£o v·ªá.

---

## Ph·∫ßn 4: B·∫£o m·∫≠t JWT - C√°c V·∫•n ƒë·ªÅ Then ch·ªët v√† Th·ª±c ti·ªÖn T·ªët nh·∫•t

JWT mang l·∫°i nhi·ªÅu l·ª£i √≠ch, nh∆∞ng n·∫øu kh√¥ng ƒë∆∞·ª£c tri·ªÉn khai c·∫©n th·∫≠n, n√≥ c√≥ th·ªÉ m·ªü ra nh·ªØng l·ªó h·ªïng b·∫£o m·∫≠t nghi√™m tr·ªçng. D∆∞·ªõi ƒë√¢y l√† c√°c v·∫•n ƒë·ªÅ c·∫ßn l∆∞u √Ω v√† c√°ch gi·∫£m thi·ªÉu r·ªßi ro:

### 1. V·∫•n ƒë·ªÅ: ƒê√°nh c·∫Øp Token qua K√™nh truy·ªÅn kh√¥ng M√£ h√≥a (HTTP)

*   **M√¥ t·∫£:** N·∫øu JWT ƒë∆∞·ª£c g·ª≠i qua k·∫øt n·ªëi HTTP th√¥ng th∆∞·ªùng (kh√¥ng ph·∫£i HTTPS), k·∫ª t·∫•n c√¥ng ·ªü gi·ªØa (Man-in-the-Middle - MitM) c√≥ th·ªÉ d·ªÖ d√†ng nghe l√©n v√† ch·∫∑n b·∫Øt to√†n b·ªô g√≥i tin, bao g·ªìm c·∫£ header `Authorization` ch·ª©a token.
*   **H·∫≠u qu·∫£:** K·∫ª t·∫•n c√¥ng c√≥ ƒë∆∞·ª£c token v√† c√≥ th·ªÉ s·ª≠ d·ª•ng n√≥ ƒë·ªÉ m·∫°o danh ng∆∞·ªùi d√πng h·ª£p l·ªá cho ƒë·∫øn khi token h·∫øt h·∫°n.
*   **‚úÖ Th·ª±c ti·ªÖn t·ªët nh·∫•t:** **LU√îN LU√îN v√† CH·ªà S·ª¨ D·ª§NG HTTPS** cho *t·∫•t c·∫£* c√°c giao ti·∫øp li√™n quan ƒë·∫øn JWT:
    *   Endpoint ƒëƒÉng nh·∫≠p (g·ª≠i credentials).
    *   Endpoint tr·∫£ v·ªÅ token.
    *   T·∫•t c·∫£ c√°c endpoint API y√™u c·∫ßu token.
    *   Endpoint l√†m m·ªõi token (refresh token).
    *   C·∫•u h√¨nh HSTS (HTTP Strict Transport Security) ƒë·ªÉ bu·ªôc tr√¨nh duy·ªát lu√¥n s·ª≠ d·ª•ng HTTPS.

### 2. V·∫•n ƒë·ªÅ: L·ªô Kh√≥a B√≠ m·∫≠t (Secret Key / Private Key)

*   **M√¥ t·∫£:** ƒê√¢y l√† "g√≥t ch√¢n Achilles" c·ªßa JWT. N·∫øu Secret Key (d√πng cho HMAC) ho·∫∑c Private Key (d√πng cho RSA/ECDSA) b·ªã l·ªô, k·∫ª t·∫•n c√¥ng c√≥ th·ªÉ:
    *   T·ª± t·∫°o ra b·∫•t k·ª≥ JWT gi·∫£ m·∫°o n√†o v·ªõi ch·ªØ k√Ω h·ª£p l·ªá.
    *   M·∫°o danh b·∫•t k·ª≥ ng∆∞·ªùi d√πng n√†o.
    *   G√°n cho m√¨nh b·∫•t k·ª≥ quy·ªÅn h·∫°n n√†o ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong claims.
*   **H·∫≠u qu·∫£:** To√†n b·ªô h·ªá th·ªëng x√°c th·ª±c d·ª±a tr√™n JWT b·ªã ph√° v·ª° ho√†n to√†n.
*   **‚úÖ Th·ª±c ti·ªÖn t·ªët nh·∫•t:**
    *   **S·ª≠ d·ª•ng kh√≥a m·∫°nh:** D√†i, ph·ª©c t·∫°p, ng·∫´u nhi√™n.
    *   **Kh√¥ng bao gi·ªù hardcode kh√≥a:** Tr√°nh nh√∫ng kh√≥a tr·ª±c ti·∫øp v√†o m√£ ngu·ªìn ho·∫∑c commit v√†o Git.
    *   **L∆∞u tr·ªØ an to√†n:**
        *   S·ª≠ d·ª•ng bi·∫øn m√¥i tr∆∞·ªùng (environment variables).
        *   S·ª≠ d·ª•ng file c·∫•u h√¨nh ƒë∆∞·ª£c b·∫£o v·ªá quy·ªÅn truy c·∫≠p nghi√™m ng·∫∑t.
        *   **T·ªët nh·∫•t:** S·ª≠ d·ª•ng c√°c h·ªá th·ªëng qu·∫£n l√Ω b√≠ m·∫≠t chuy√™n d·ª•ng (Secret Management Systems) nh∆∞ HashiCorp Vault, AWS Secrets Manager, Azure Key Vault, Google Secret Manager.
    *   **Gi·ªõi h·∫°n quy·ªÅn truy c·∫≠p:** Ch·ªâ c·∫•p quy·ªÅn truy c·∫≠p kh√≥a cho c√°c ti·∫øn tr√¨nh/d·ªãch v·ª• th·ª±c s·ª± c·∫ßn thi·∫øt.
    *   **Xoay v√≤ng kh√≥a (Key Rotation):** ƒê·ªãnh k·ª≥ thay ƒë·ªïi kh√≥a (v√≠ d·ª•: v√†i th√°ng m·ªôt l·∫ßn) ƒë·ªÉ gi·∫£m thi·ªÉu t√°c ƒë·ªông n·∫øu kh√≥a c≈© b·ªã l·ªô.

### 3. V·∫•n ƒë·ªÅ: L·ªó h·ªïng Thu·∫≠t to√°n (`alg`)

*   **M√¥ t·∫£:** K·∫ª t·∫•n c√¥ng c√≥ th·ªÉ c·ªë g·∫Øng thao t√∫ng tr∆∞·ªùng `alg` trong Header ƒë·ªÉ l·ª´a server b·ªè qua ho·∫∑c x√°c minh ch·ªØ k√Ω sai c√°ch.
    *   **`alg: "none"`:** K·∫ª t·∫•n c√¥ng s·ª≠a `alg` th√†nh `"none"` v√† x√≥a b·ªè ph·∫ßn Signature. N·∫øu server kh√¥ng ki·ªÉm tra `alg` v√† ch·∫•p nh·∫≠n `"none"`, n√≥ s·∫Ω coi token gi·∫£ m·∫°o l√† h·ª£p l·ªá m√† kh√¥ng c·∫ßn x√°c minh ch·ªØ k√Ω.
    *   **Nh·∫ßm l·∫´n Thu·∫≠t to√°n (Algorithm Confusion):** T·∫•n c√¥ng tinh vi h∆°n, v√≠ d·ª• l·ª´a server d√πng Public Key (c·ªßa RS256) nh∆∞ l√† Secret Key (cho HS256). N·∫øu k·∫ª t·∫•n c√¥ng bi·∫øt Public Key (th∆∞·ªùng l√† c√¥ng khai), h·ªç c√≥ th·ªÉ t·∫°o token gi·∫£ m·∫°o v·ªõi ch·ªØ k√Ω HS256 h·ª£p l·ªá.
*   **‚úÖ Th·ª±c ti·ªÖn t·ªët nh·∫•t:**
    *   **Server PH·∫¢I x√°c minh `alg`:** Lu√¥n ki·ªÉm tra gi√° tr·ªã `alg` trong Header nh·∫≠n ƒë∆∞·ª£c.
    *   **S·ª≠ d·ª•ng Whitelist:** Ch·ªâ ch·∫•p nh·∫≠n m·ªôt danh s√°ch c√°c thu·∫≠t to√°n c·ª• th·ªÉ m√† server h·ªó tr·ª£ v√† mong ƒë·ª£i (v√≠ d·ª•: ch·ªâ `["HS256"]` ho·∫∑c `["RS256", "ES256"]`).
    *   **Tuy·ªát ƒë·ªëi T·ª™ CH·ªêI `alg: "none"`**.
    *   **S·ª≠ d·ª•ng th∆∞ vi·ªán JWT uy t√≠n:** Ch·ªçn c√°c th∆∞ vi·ªán ƒë∆∞·ª£c c·∫≠p nh·∫≠t th∆∞·ªùng xuy√™n v√† ƒë√£ ƒë∆∞·ª£c ki·ªÉm tra v·ªÅ c√°c l·ªó h·ªïng ph·ªï bi·∫øn. C·∫•u h√¨nh th∆∞ vi·ªán ƒë√∫ng c√°ch ƒë·ªÉ ch·ªâ ƒë·ªãnh r√µ thu·∫≠t to√°n v√† kh√≥a t∆∞∆°ng ·ª©ng khi x√°c minh.

### 4. V·∫•n ƒë·ªÅ: Token B·ªã L·ªô v√† Th·ªùi Gian H·∫øt H·∫°n (`exp`)

*   **M√¥ t·∫£:** N·∫øu m·ªôt `accessToken` b·ªã ƒë√°nh c·∫Øp (v√≠ d·ª• qua XSS, malware, ho·∫∑c ng∆∞·ªùi d√πng v√¥ t√¨nh l√†m l·ªô), k·∫ª t·∫•n c√¥ng c√≥ th·ªÉ s·ª≠ d·ª•ng n√≥ cho ƒë·∫øn khi token t·ª± h·∫øt h·∫°n. N·∫øu th·ªùi gian h·∫øt h·∫°n (`exp`) qu√° d√†i (ng√†y, tu·∫ßn, th√°ng), r·ªßi ro s·∫Ω k√©o d√†i t∆∞∆°ng ·ª©ng.
*   **‚úÖ Th·ª±c ti·ªÖn t·ªët nh·∫•t:**
    *   **Lu√¥n ƒë·∫∑t `exp` cho `accessToken`:** Kh√¥ng bao gi·ªù c·∫•p token kh√¥ng c√≥ th·ªùi h·∫°n.
    *   **Th·ªùi h·∫°n `accessToken` NG·∫ÆN:** ƒê·∫∑t `exp` ng·∫Øn m·ªôt c√°ch h·ª£p l√Ω (5 ph√∫t, 15 ph√∫t, t·ªëi ƒëa 1 gi·ªù). ƒêi·ªÅu n√†y gi·ªõi h·∫°n "c·ª≠a s·ªï c∆° h·ªôi" cho k·∫ª t·∫•n c√¥ng n·∫øu token b·ªã l·ªô.
    *   **K·∫øt h·ª£p v·ªõi Refresh Token:** ƒê·ªÉ tr√°nh b·∫Øt ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p l·∫°i li√™n t·ª•c do `accessToken` h·∫øt h·∫°n ng·∫Øn, h√£y s·ª≠ d·ª•ng c∆° ch·∫ø Refresh Token (xem m·ª•c 7).
    *   **Server PH·∫¢I ki·ªÉm tra `exp`:** Lu√¥n x√°c minh token ch∆∞a h·∫øt h·∫°n tr∆∞·ªõc khi x·ª≠ l√Ω y√™u c·∫ßu.

### 5. V·∫•n ƒë·ªÅ: ƒê√°nh c·∫Øp Token ph√≠a Client (XSS)

*   **M√¥ t·∫£:** N·∫øu ·ª©ng d·ª•ng web c√≥ l·ªó h·ªïng Cross-Site Scripting (XSS), k·∫ª t·∫•n c√¥ng c√≥ th·ªÉ ti√™m m√£ JavaScript ƒë·ªôc h·∫°i v√†o trang web. M√£ n√†y c√≥ th·ªÉ ch·∫°y trong tr√¨nh duy·ªát c·ªßa ng∆∞·ªùi d√πng v√†:
    *   ƒê·ªçc tr·ªôm token n·∫øu n√≥ ƒë∆∞·ª£c l∆∞u trong `localStorage` ho·∫∑c `sessionStorage`.
    *   G·ª≠i token b·ªã ƒë√°nh c·∫Øp v·ªÅ m√°y ch·ªß c·ªßa k·∫ª t·∫•n c√¥ng.
*   **H·∫≠u qu·∫£:** M·∫•t phi√™n ƒëƒÉng nh·∫≠p c·ªßa ng∆∞·ªùi d√πng.
*   **‚úÖ Th·ª±c ti·ªÖn t·ªët nh·∫•t:**
    *   **Ph√≤ng ch·ªëng XSS tri·ªát ƒë·ªÉ:** ƒê√¢y l√† bi·ªán ph√°p quan tr·ªçng nh·∫•t. S·ª≠ d·ª•ng c√°c framework hi·ªán ƒë·∫°i c√≥ c∆° ch·∫ø ch·ªëng XSS s·∫µn c√≥, sanitize (l√†m s·∫°ch) m·ªçi d·ªØ li·ªáu ƒë·∫ßu v√†o t·ª´ ng∆∞·ªùi d√πng tr∆∞·ªõc khi hi·ªÉn th·ªã, s·ª≠ d·ª•ng Content Security Policy (CSP).
    *   **L∆∞u tr·ªØ Token An to√†n:**
        *   **∆Øu ti√™n `HttpOnly` Cookie:** ƒê·∫∑c bi·ªát ƒë·ªëi v·ªõi `refreshToken` v√† c√≥ th·ªÉ c·∫£ `accessToken`. Cookie `HttpOnly` kh√¥ng th·ªÉ b·ªã truy c·∫≠p b·ªüi JavaScript, gi·∫£m thi·ªÉu ƒë√°ng k·ªÉ nguy c∆° b·ªã ƒë√°nh c·∫Øp qua XSS.
        *   **C·∫•u h√¨nh Cookie ch·∫∑t ch·∫Ω:** Lu√¥n d√πng c·ªù `Secure` (ch·ªâ g·ª≠i qua HTTPS) v√† `SameSite=Strict` ho·∫∑c `SameSite=Lax` (ƒë·ªÉ ch·ªëng CSRF).
        *   N·∫øu b·∫Øt bu·ªôc d√πng `localStorage` cho `accessToken`: Ph·∫£i c·ª±c k·ª≥ ch√∫ tr·ªçng v√†o vi·ªác v√° m·ªçi l·ªó h·ªïng XSS.

### 6. V·∫•n ƒë·ªÅ: Kh√≥ Thu h·ªìi Token (Revocation)

*   **M√¥ t·∫£:** Do t√≠nh ch·∫•t stateless, m·ªôt JWT khi ƒë√£ ƒë∆∞·ª£c c·∫•p ph√°t s·∫Ω ƒë∆∞·ª£c coi l√† h·ª£p l·ªá cho ƒë·∫øn khi h·∫øt h·∫°n (`exp`). Kh√¥ng c√≥ c∆° ch·∫ø t√≠ch h·ª£p s·∫µn ƒë·ªÉ "v√¥ hi·ªáu h√≥a" m·ªôt token c·ª• th·ªÉ ngay l·∫≠p t·ª©c n·∫øu n√≥ b·ªã l·ªô ho·∫∑c ng∆∞·ªùi d√πng mu·ªën logout/ƒë·ªïi m·∫≠t kh·∫©u.
*   **‚úÖ Th·ª±c ti·ªÖn t·ªët nh·∫•t (Th∆∞·ªùng ph·∫£i ƒë√°nh ƒë·ªïi m·ªôt ph·∫ßn t√≠nh stateless):**
    *   **Chi·∫øn l∆∞·ª£c ph·ªï bi·∫øn nh·∫•t: `accessToken` ng·∫Øn h·∫°n + `refreshToken` d√†i h·∫°n:**
        *   Khi c·∫ßn thu h·ªìi (logout, ƒë·ªïi pass, kh√≥a t√†i kho·∫£n): Ch·ªâ c·∫ßn **v√¥ hi·ªáu h√≥a `refreshToken`** ph√≠a server (v√≠ d·ª•: x√≥a kh·ªèi DB l∆∞u tr·ªØ refresh token, ho·∫∑c th√™m v√†o blacklist).
        *   Khi `accessToken` hi·ªán t·∫°i h·∫øt h·∫°n, client s·∫Ω c·ªë g·∫Øng d√πng `refreshToken` ƒë√£ b·ªã v√¥ hi·ªáu h√≥a ƒë·ªÉ l·∫•y `accessToken` m·ªõi -> Server t·ª´ ch·ªëi -> Ng∆∞·ªùi d√πng b·ªã bu·ªôc logout ho·∫∑c ph·∫£i x√°c th·ª±c l·∫°i.
    *   **Blacklisting (Danh s√°ch ƒëen):**
        *   Server duy tr√¨ m·ªôt danh s√°ch (th∆∞·ªùng trong cache nhanh nh∆∞ Redis) ch·ª©a ID (`jti`) c·ªßa c√°c token ƒë√£ b·ªã thu h·ªìi.
        *   M·ªói l·∫ßn x√°c th·ª±c token, server ph·∫£i ki·ªÉm tra xem `jti` c·ªßa token ƒë√≥ c√≥ n·∫±m trong blacklist kh√¥ng.
        *   *Nh∆∞·ª£c ƒëi·ªÉm:* Th√™m state v√†o server, tƒÉng ƒë·ªô tr·ªÖ do ph·∫£i ki·ªÉm tra cache/DB. C·∫ßn c∆° ch·∫ø d·ªçn d·∫πp blacklist.
    *   **Ki·ªÉm tra Phi√™n b·∫£n/Timestamp:**
        *   L∆∞u m·ªôt gi√° tr·ªã (v√≠ d·ª•: `password_version`, `last_logout_timestamp`) cho m·ªói user trong DB.
        *   Th√™m gi√° tr·ªã n√†y v√†o Payload c·ªßa JWT khi c·∫•p ph√°t.
        *   Khi x√°c th·ª±c, server l·∫•y gi√° tr·ªã m·ªõi nh·∫•t t·ª´ DB v√† so s√°nh v·ªõi gi√° tr·ªã trong token. N·∫øu kh√¥ng kh·ªõp -> T·ª´ ch·ªëi token.
        *   *Nh∆∞·ª£c ƒëi·ªÉm:* Y√™u c·∫ßu truy v·∫•n DB m·ªói l·∫ßn x√°c th·ª±c token, g·∫ßn gi·ªëng c∆° ch·∫ø session.

### 7. Vai tr√≤ Quan tr·ªçng c·ªßa Refresh Token

Refresh Token l√† m·ªôt "ng∆∞·ªùi b·∫°n ƒë·ªìng h√†nh" kh√¥ng th·ªÉ thi·∫øu c·ªßa Access Token trong c√°c h·ªá th·ªëng JWT hi·ªán ƒë·∫°i, gi√∫p c√¢n b·∫±ng gi·ªØa b·∫£o m·∫≠t v√† tr·∫£i nghi·ªám ng∆∞·ªùi d√πng.

*   **Kh√°i ni·ªám:** L√† m·ªôt credential ƒë·∫∑c bi·ªát, ƒë∆∞·ª£c c·∫•p c√πng l√∫c v·ªõi `accessToken` nh∆∞ng c√≥ **th·ªùi gian s·ªëng d√†i h∆°n nhi·ªÅu** (v√≠ d·ª•: v√†i ng√†y, v√†i tu·∫ßn, ho·∫∑c ƒë√°nh d·∫•u l√† "cho ƒë·∫øn khi b·ªã thu h·ªìi"). N√≥ **ch·ªâ d√πng cho m·ªôt m·ª•c ƒë√≠ch duy nh·∫•t**: l·∫•y `accessToken` m·ªõi.
*   **Lu·ªìng ho·∫°t ƒë·ªông v·ªõi Refresh Token:**
    1.  Ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p -> Nh·∫≠n c·∫£ `accessToken` (ng·∫Øn h·∫°n) v√† `refreshToken` (d√†i h·∫°n).
    2.  Client d√πng `accessToken` ƒë·ªÉ g·ªçi c√°c API.
    3.  Khi `accessToken` h·∫øt h·∫°n (server tr·∫£ l·ªói 401), client **kh√¥ng** b·∫Øt ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p l·∫°i ngay.
    4.  Thay v√†o ƒë√≥, client **√¢m th·∫ßm** g·ª≠i `refreshToken` (ƒë∆∞·ª£c l∆∞u tr·ªØ an to√†n, v√≠ d·ª• trong HttpOnly cookie) ƒë·∫øn m·ªôt **endpoint ƒë·∫∑c bi·ªát** tr√™n server (v√≠ d·ª•: `/api/auth/refresh`).
    5.  Server x√°c th·ª±c `refreshToken` (ki·ªÉm tra xem n√≥ c√≥ t·ªìn t·∫°i, c√≤n h·∫°n, v√† ch∆∞a b·ªã thu h·ªìi trong DB/blacklist kh√¥ng).
    6.  N·∫øu `refreshToken` h·ª£p l·ªá: Server c·∫•p m·ªôt **`accessToken` m·ªõi** (v√† t√πy ch·ªçn, m·ªôt **`refreshToken` m·ªõi** - g·ªçi l√† **rotation**) v√† g·ª≠i v·ªÅ cho client.
    7.  Client nh·∫≠n `accessToken` m·ªõi v√† t·ª± ƒë·ªông th·ª≠ l·∫°i y√™u c·∫ßu API ban ƒë·∫ßu ƒë√£ th·∫•t b·∫°i. Ng∆∞·ªùi d√πng kh√¥ng h·ªÅ hay bi·∫øt qu√° tr√¨nh n√†y.
    8.  N·∫øu `refreshToken` kh√¥ng h·ª£p l·ªá (ƒë√£ h·∫øt h·∫°n, b·ªã thu h·ªìi): Server t·ª´ ch·ªëi c·∫•p token m·ªõi, client bi·∫øt r·∫±ng phi√™n ƒëƒÉng nh·∫≠p ƒë√£ th·ª±c s·ª± k·∫øt th√∫c v√† chuy·ªÉn h∆∞·ªõng ng∆∞·ªùi d√πng v·ªÅ trang ƒëƒÉng nh·∫≠p.
*   **L·ª£i √≠ch:**
    *   **B·∫£o m·∫≠t T·ªët h∆°n:** Gi·∫£m thi·ªÉu r·ªßi ro t·ª´ `accessToken` b·ªã l·ªô (do th·ªùi h·∫°n ng·∫Øn). `refreshToken` √≠t ƒë∆∞·ª£c truy·ªÅn ƒëi h∆°n v√† c√≥ th·ªÉ ƒë∆∞·ª£c qu·∫£n l√Ω/thu h·ªìi ph√≠a server.
    *   **Tr·∫£i nghi·ªám Ng∆∞·ªùi d√πng (UX) T·ªët h∆°n:** Ng∆∞·ªùi d√πng kh√¥ng b·ªã b·∫Øt ƒëƒÉng nh·∫≠p l·∫°i th∆∞·ªùng xuy√™n.
    *   **Cung c·∫•p C∆° ch·∫ø Thu h·ªìi Hi·ªáu qu·∫£:** V√¥ hi·ªáu h√≥a `refreshToken` ph√≠a server l√† c√°ch ƒë√°ng tin c·∫≠y ƒë·ªÉ ch·∫•m d·ª©t phi√™n ƒëƒÉng nh·∫≠p.
*   **L∆∞u tr·ªØ Refresh Token:** **C·ª±c k·ª≥ quan tr·ªçng!** V√¨ `refreshToken` r·∫•t m·∫°nh, ph·∫£i l∆∞u tr·ªØ n√≥ c·ª±c k·ª≥ an to√†n. **Khuy·∫øn ngh·ªã m·∫°nh m·∫Ω:** L∆∞u trong **`HttpOnly`, `Secure`, `SameSite` Cookie**.
*   **Refresh Token Rotation (N√™n d√πng):** M·ªói khi `refreshToken` ƒë∆∞·ª£c s·ª≠ d·ª•ng th√†nh c√¥ng, server n√™n c·∫•p m·ªôt `refreshToken` *m·ªõi* v√† v√¥ hi·ªáu h√≥a `refreshToken` c≈©. ƒêi·ªÅu n√†y gi√∫p ph√°t hi·ªán n·∫øu `refreshToken` b·ªã ƒë√°nh c·∫Øp v√† s·ª≠ d·ª•ng l·∫°i (v√¨ k·∫ª t·∫•n c√¥ng v√† ng∆∞·ªùi d√πng th·∫≠t s·∫Ω c√≥ `refreshToken` kh√°c nhau, v√† ch·ªâ m·ªôt c√°i ƒë∆∞·ª£c ch·∫•p nh·∫≠n ·ªü l·∫ßn d√πng ti·∫øp theo).

### 8. T·ªïng k·∫øt c√°c Th·ª±c ti·ªÖn T·ªët nh·∫•t

1.  **HTTPS Everywhere.**
2.  **B·∫£o v·ªá Secret/Private Key nh∆∞ t√†i s·∫£n qu√Ω gi√° nh·∫•t.**
3.  **X√°c minh `alg` nghi√™m ng·∫∑t, t·ª´ ch·ªëi `none`.**
4.  **ƒê·∫∑t `exp` ng·∫Øn cho `accessToken`.**
5.  **Kh√¥ng bao gi·ªù ƒë·∫∑t d·ªØ li·ªáu nh·∫°y c·∫£m trong Payload.**
6.  **Ph√≤ng ch·ªëng XSS tri·ªát ƒë·ªÉ.**
7.  **∆Øu ti√™n l∆∞u token (ƒë·∫∑c bi·ªát l√† Refresh Token) trong `HttpOnly`, `Secure`, `SameSite` Cookie.**
8.  **S·ª≠ d·ª•ng Refresh Token ƒë·ªÉ c√¢n b·∫±ng b·∫£o m·∫≠t v√† UX, ƒë·ªìng th·ªùi c√≥ c∆° ch·∫ø thu h·ªìi.**
9.  **Xem x√©t Refresh Token Rotation.**
10. **S·ª≠ d·ª•ng th∆∞ vi·ªán JWT uy t√≠n v√† c·∫≠p nh·∫≠t.**
11. **Th√™m c√°c claim `iss`, `aud`, `jti` ƒë·ªÉ tƒÉng c∆∞·ªùng b·∫£o m·∫≠t v√† qu·∫£n l√Ω.**

---

**Ho√†n th√†nh.**
